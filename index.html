<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function main() {
        await liff.init({ liffId: "1654380017-ad8j2NgM" }); // ◀️ **สำคัญ:** ใส่ LIFF ID ของคุณที่นี่
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById('userID').value = profile.userId;
        }
    }
    main();

    const scriptURL = 'https://script.google.com/macros/s/AKfycbz-oVVVdJM03S-QxFwAVjf-Zj-xrb464P5YPauUqIa-DE-uc2NB7dL6pGXBsHqlnQve/exec'; // ◀️ **สำคัญ:** ใช้ URL ที่ได้จากการ Deploy ของคุณ
    const form = document.forms['hello-sheet'];
    
    // Element References
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photoPreview = document.getElementById('photo-preview');
    const startCameraBtn = document.getElementById('start-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const switchCameraBtn = document.getElementById('switch-camera-btn');
    const facePhotoDataInput = document.getElementById('facePhotoData');
    const cameraPlaceholder = document.getElementById('camera-placeholder');
    const faceOverlay = document.getElementById('face-overlay');
    
    // Camera State
    let currentStream = null;
    let currentFacingMode = 'user'; // 'user' = front camera, 'environment' = back camera

    /**
     * Stops the currently active camera stream.
     * This is necessary to release the camera hardware so it can be used again.
     */
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
    }

    /**
     * Initializes and starts the camera. It will request permission from the user
     * only on the first call. Subsequent calls (like switching cameras) will reuse the permission.
     */
    async function startCamera() {
        // Stop any existing stream before starting a new one.
        stopCamera();

        // Define constraints for the camera.
        const constraints = {
            video: { 
                facingMode: currentFacingMode,
                // You can add other constraints like zoom here if needed.
                // For example, some browsers support zoom on the back camera.
                // zoom: currentFacingMode === 'environment' ? 2.0 : 1.0
            },
            audio: false
        };

        try {
            // Request camera access. The browser will ask for permission here ONCE per session.
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            
            // Update UI to show the camera feed and relevant buttons
            video.style.display = 'block';
            faceOverlay.style.display = 'block'; 
            captureBtn.style.display = 'inline-block';
            switchCameraBtn.style.display = 'inline-block';
            startCameraBtn.style.display = 'none';
            cameraPlaceholder.style.display = 'none';
            photoPreview.style.display = 'none';

        } catch (err) {
            console.error("Error accessing camera: ", err);
            // Reset UI if camera access fails
            faceOverlay.style.display = 'none';
            switchCameraBtn.style.display = 'none';
            startCameraBtn.style.display = 'inline-block';
            captureBtn.style.display = 'none';
            cameraPlaceholder.style.display = 'block';
            Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเข้าถึงกล้องได้ กรุณาตรวจสอบการอนุญาตใน Browser ของคุณ', 'error');
        }
    }

    // Event listener for the "Open Camera" / "Retake Photo" button
    startCameraBtn.addEventListener('click', () => {
        // Always start with the front camera for consistency when starting fresh.
        currentFacingMode = 'user';
        startCamera();
    });

    // Event listener for the "Switch Camera" button
    switchCameraBtn.addEventListener('click', () => {
        // Toggle between front and back camera
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        // Restart the camera with the new mode. Permission is already granted.
        startCamera();
    });

    // Event listener for the "Capture" button
    captureBtn.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const dataURL = canvas.toDataURL('image/jpeg');
        photoPreview.src = dataURL;
        facePhotoDataInput.value = dataURL;
        
        // Stop the camera stream after taking the picture
        stopCamera(); 
        
        // Update UI to show the preview and "Retake" button
        video.style.display = 'none';
        faceOverlay.style.display = 'none';
        photoPreview.style.display = 'block';
        captureBtn.style.display = 'none';
        switchCameraBtn.style.display = 'none';
        startCameraBtn.style.display = 'inline-block';
        startCameraBtn.innerHTML = '<i class="fas fa-camera"></i> ถ่ายรูปใหม่'; // Change text to "Retake Photo"
    });

    // Event listener for the ID card file input
    document.getElementById('idCardPhoto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const label = this.nextElementSibling;
        const preview = document.getElementById('idCardPhotoPreview');

        if (file) {
            label.innerText = file.name;
            preview.innerText = `✔️ เลือกไฟล์: ${file.name}`;
            preview.style.display = 'block';
        } else {
            label.innerText = 'เลือกรูปบัตรประชาชน...';
            preview.style.display = 'none';
        }
    });

    // Form submission handler
    form.addEventListener('submit', async e => {
        e.preventDefault();

        const idCardPhotoInput = document.getElementById('idCardPhoto');

        // Validate all required fields
        if (!form.checkValidity() || !facePhotoDataInput.value || idCardPhotoInput.files.length === 0) {
            Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกข้อมูล, ถ่ายรูปใบหน้า, แนบไฟล์บัตรประชาชน และกดยินยอมให้ครบถ้วน', 'warning');
            return;
        }

        Swal.fire({
            title: 'กำลังบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่ ระบบกำลังอัปโหลดไฟล์',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        try {
            const facePhotoBase64 = facePhotoDataInput.value;
            const idCardPhotoBase64 = await fileToBase64(idCardPhotoInput.files[0]);

            const formData = new FormData(form);
            const dataObject = {};
            formData.forEach((value, key) => { dataObject[key] = value; });
            
            dataObject.action = 'register';
            dataObject.facePhoto = facePhotoBase64;
            dataObject.idCardPhoto = idCardPhotoBase64;
            dataObject.Consent = document.getElementById('consentCheck').checked ? 'ยินยอม' : 'ไม่ยินยอม';

            // Using 'no-cors' mode means you won't get a response back in the script,
            // but the request will be sent to the server. This is typical for Google Apps Script web apps.
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors', 
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataObject),
                redirect: 'follow'
            });

             Swal.fire({
                 position: 'center', icon: 'success', title: 'ส่งข้อมูลสำเร็จ!',
                 text: 'ข้อมูลของคุณถูกส่งเข้าระบบเรียบร้อยแล้ว กำลังรอการตรวจสอบ', showConfirmButton: false, timer: 3000
             }).then(() => {
                 if (liff.isInClient()) {
                     liff.closeWindow();
                 } else {
                     window.location.reload();
                 }
             });

        } catch (error) {
             console.error('Error!', error.message);
             Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message, 'error');
        }
    });
</script>
