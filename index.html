<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR-JMT</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-image: url('https://img2.pic.in.th/pic/Cover808900978ea91797.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .register-card {
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: none;
            display: flex;
            flex-direction: row;
            max-width: 900px;
            width: 100%;
        }
        .register-image-side {
            background: url('https://img2.pic.in.th/pic/Gemini_Generated_Image_rqnmqyrqnmqyrqnm.png') center/cover;
            width: 45%;
        }
        .register-form-side {
            width: 55%;
            padding: 3rem;
        }
        .card-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        .card-subtitle {
            color: #6c757d;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .input-group-text {
            background-color: transparent;
            border-right: none;
            color: #343a40;
            font-size: 1.1rem;
        }
        .form-control {
            border-left: none;
            border-radius: 0 0.25rem 0.25rem 0;
            padding-left: 0;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .form-control:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #555;
        }
        .btn-success {
            background: linear-gradient(45deg, #1E8449, #28B463);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 132, 73, 0.3);
        }
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 132, 73, 0.4);
        }
        .btn-success:disabled {
            background: #a5d6a7;
            cursor: not-allowed;
        }
        .consent-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            transition: box-shadow 0.2s ease-in-out;
        }
        .consent-section:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .consent-title {
            font-weight: 700;
            color: #343a40;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        .custom-switch .custom-control-label {
            color: #495057;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .custom-control-input:checked~.custom-control-label::before {
            border-color: #1E8449;
            background-color: #28B463;
        }
        /* */
        .zoom-controls {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            padding: 8px 0;
            text-align: center;
        }
        .zoom-controls label {
            font-size: 0.8rem;
            margin-right: 10px;
            vertical-align: middle;
        }
        .zoom-controls input[type="range"] {
            width: 60%;
            vertical-align: middle;
        }
        /* */
        @media (max-width: 768px) {
            .register-image-side { display: none; }
            .register-form-side { width: 100%; padding: 2rem; }
            .register-card { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="register-card">
    <div class="register-image-side"></div>
    <div class="register-form-side">
        <div class="text-center mb-4">
            <img src="https://img5.pic.in.th/file/secure-sv1/-1920-x-300-px.png" alt="Company Logo" style="max-width: 250px; margin-bottom: 1.5rem;">
            <h3 class="card-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <p class="card-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏•‡∏ô‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á!</p>
        </div>

        <form method="post" autocomplete="off" name="hello-sheet" id="registerForm">
            <div class="mb-3">
                <label for="IdEmployee" class="form-label">Employee ID</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span></div>
                    <input type="text" class="form-control" id="IdEmployee" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" name="‡∏£‡∏´‡∏±‡∏™" required>
                </div>
            </div>
             <div class="mb-3">
                <label for="fullName" class="form-label">Full Name</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-user"></i></span></div>
                    <input type="text" class="form-control" id="fullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)" name="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required readonly>
                </div>
            </div>

            <div class="mb-3">
                <label for="nationalId" class="form-label">National ID</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa-solid fa-id-card"></i></span></div>
                    <input type="tel" class="form-control" id="nationalId" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)" name="‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" required maxlength="13" pattern="\d{13}" readonly>
                </div>
            </div>
            
            <input type="hidden" name="Key" id="userID">
            <div class="mb-3">
                <label class="form-label">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</label>
                <div id="face-camera-container" class="text-center bg-light p-2" style="border-radius: 10px; position: relative; overflow: hidden;">
                    <video id="face-video" width="100%" height="auto" autoplay playsinline style="display: none; transform: scaleX(-1);"></video>
                    <canvas id="face-canvas" style="display:none;"></canvas>
                    <img id="face-overlay" 
                         src="https://img2.pic.in.th/pic/-44e1002fd11c7044b.png" 
                         alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤" 
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: none; pointer-events: none; opacity: 0.7;">
                    <img id="face-photo-preview" src="" alt="‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢" style="max-width: 100%; border-radius: 10px; display: none; margin: auto;" />
                    <div id="face-camera-placeholder">
                          <i class="fas fa-camera fa-3x text-muted"></i>
                          <p class="text-muted mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</p>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <button type="button" id="start-face-camera-btn" class="btn btn-info btn-sm"> <i class="fas fa-camera"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤</button>
                    <button type="button" id="capture-face-btn" class="btn btn-primary btn-sm" style="display: none;"> <i class="fas fa-circle-check"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
                    <button type="button" id="retake-face-btn" class="btn btn-warning btn-sm" style="display: none;"> <i class="fas fa-redo"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <input type="hidden" name="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤" id="facePhotoData" required>
            </div>
            <div class="mb-3">
                <label class="form-label">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                <div id="id-card-camera-container" class="text-center bg-light p-2" style="border-radius: 10px; position: relative; overflow: hidden;">
                    <video id="id-card-video" width="100%" height="auto" autoplay playsinline style="display: none;"></video>
                    <canvas id="id-card-canvas" style="display:none;"></canvas>
                    <img id="id-card-overlay"
                         src="https://img5.pic.in.th/file/secure-sv1/-101583db1e932988ee.png" 
                         alt="‡∏Å‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" 
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: none; pointer-events: none; opacity: 0.8;">
                    <img id="id-card-photo-preview" src="" alt="‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢" style="max-width: 100%; border-radius: 10px; display: none; margin: auto;" />
                    <div id="id-card-camera-placeholder">
                          <i class="fas fa-id-card fa-3x text-muted"></i>
                          <p class="text-muted mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£</p>
                    </div>
                </div>
                <div id="zoom-controls-container" class="zoom-controls">
                     <label for="zoom-slider"><i class="fas fa-search-plus"></i> ‡∏ã‡∏π‡∏°:</label>
                     <input type="range" id="zoom-slider">
                </div>
                 <div class="text-center mt-2">
                    <button type="button" id="start-id-card-camera-btn" class="btn btn-info btn-sm"> <i class="fas fa-camera-rotate"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</button>
                    <button type="button" id="capture-id-card-btn" class="btn btn-primary btn-sm" style="display: none;"> <i class="fas fa-circle-check"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
                    <button type="button" id="retake-id-card-btn" class="btn btn-warning btn-sm" style="display: none;"> <i class="fas fa-redo"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <input type="hidden" name="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô" id="idCardPhotoData" required>
            </div>
            <div class="consent-section">
                <h5 class="consent-title"><i class="fa-solid fa-shield-halved"></i> ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</h5>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="consentCheck" name="Consent" value="‚úÖ ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°" required>
                    <label class="custom-control-label" for="consentCheck">
                        ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏Å‡πá‡∏ö ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏° ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Line : HR-JMT
                    </label>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success fw-bold w-100" id="registerBtn" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- LIFF Initialization ---
    async function main() {
        try {
            await liff.init({ liffId: "1654380017-ad8j2NgM" }); // ‚óÄÔ∏è **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById('userID').value = profile.userId;
            }
        } catch (error) {
            console.error('LIFF initialization failed', error);
        }
    }
    main();

    // --- Form & Sheet Configuration ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyZqhsGFfP8QOIjRsPlCO45P0594KzEG8BtyODlAp7Dnoxg-5Prnekh7PAqKSm7I7L4/exec'; // ‚óÄÔ∏è **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const form = document.forms['hello-sheet'];
    const registerBtn = document.getElementById('registerBtn');
    const consentCheckbox = document.getElementById('consentCheck');
    const employeeIdInput = document.getElementById('IdEmployee');
    const fullNameInput = document.getElementById('fullName');
    const nationalIdInput = document.getElementById('nationalId');

    // --- ‚ú® [‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà] REUSABLE CAMERA LOGIC with ZOOM & FOCUS ---
    function setupCamera(options) {
        const startBtn = document.getElementById(options.startBtnId);
        const captureBtn = document.getElementById(options.captureBtnId);
        const retakeBtn = document.getElementById(options.retakeBtnId);
        const videoEl = document.getElementById(options.videoId);
        const canvasEl = document.getElementById(options.canvasId);
        const previewEl = document.getElementById(options.previewId);
        const dataInputEl = document.getElementById(options.dataInputId);
        const placeholderEl = document.getElementById(options.placeholderId);
        const overlayEl = options.overlayId ? document.getElementById(options.overlayId) : null;
        
        // üìç [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á Element ‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°
        const zoomControlsContainer = options.zoomControlsContainerId ? document.getElementById(options.zoomControlsContainerId) : null;
        const zoomSlider = options.zoomSliderId ? document.getElementById(options.zoomSliderId) : null;

        let currentStream;

        const startCamera = async () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            // üìç [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ã‡∏π‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            if(zoomControlsContainer) zoomControlsContainer.style.display = 'none';

            try {
                // üìç [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á constraints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞ Auto Focus
                const constraints = {
                    video: {
                        facingMode: options.facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏™‡∏°‡∏≠
                        focusMode: 'continuous' 
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoEl.srcObject = currentStream;
                videoEl.style.display = 'block';
                if (overlayEl) overlayEl.style.display = 'block';
                
                placeholderEl.style.display = 'none';
                previewEl.style.display = 'none';
                startBtn.style.display = 'none';
                captureBtn.style.display = 'inline-block';
                retakeBtn.style.display = 'none';

                // üìç [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°
                const [track] = currentStream.getVideoTracks();
                const capabilities = track.getCapabilities();

                if (zoomSlider && 'zoom' in capabilities) {
                    zoomControlsContainer.style.display = 'block'; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡∏ã‡∏π‡∏°
                    zoomSlider.min = capabilities.zoom.min;
                    zoomSlider.max = capabilities.zoom.max;
                    zoomSlider.step = capabilities.zoom.step;
                    zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

                    zoomSlider.oninput = (event) => {
                        track.applyConstraints({ advanced: [{ zoom: event.target.value }] });
                    };
                }

            } catch (err) {
                console.error(`Error accessing ${options.facingMode} camera:`, err);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${err.name}. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE`, 'error');
            }
        };

        const captureImage = () => {
            const context = canvasEl.getContext('2d');
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            
            if (options.facingMode === 'user') {
                context.translate(canvasEl.width, 0);
                context.scale(-1, 1);
            }
            context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            const dataUrl = canvasEl.toDataURL('image/jpeg', 0.9);
            dataInputEl.value = dataUrl;
            previewEl.src = dataUrl;

            videoEl.style.display = 'none';
            if (overlayEl) overlayEl.style.display = 'none';
            previewEl.style.display = 'block';
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline-block';

            // üìç [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡∏ã‡∏π‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
            if(zoomControlsContainer) zoomControlsContainer.style.display = 'none';

            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
        };

        startBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', captureImage);
        retakeBtn.addEventListener('click', startCamera);
    }

    // Initialize Face Camera (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤)
    setupCamera({
        startBtnId: 'start-face-camera-btn',
        captureBtnId: 'capture-face-btn',
        retakeBtnId: 'retake-face-btn',
        videoId: 'face-video',
        canvasId: 'face-canvas',
        previewId: 'face-photo-preview',
        dataInputId: 'facePhotoData',
        placeholderId: 'face-camera-placeholder',
        overlayId: 'face-overlay',
        facingMode: 'user'
    });

    // Initialize ID Card Camera (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
    // üìç [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô options
    setupCamera({
        startBtnId: 'start-id-card-camera-btn',
        captureBtnId: 'capture-id-card-btn',
        retakeBtnId: 'retake-id-card-btn',
        videoId: 'id-card-video',
        canvasId: 'id-card-canvas',
        previewId: 'id-card-photo-preview',
        dataInputId: 'idCardPhotoData',
        placeholderId: 'id-card-camera-placeholder',
        overlayId: 'id-card-overlay',
        facingMode: 'environment',
        zoomControlsContainerId: 'zoom-controls-container', // ID ‡∏Ç‡∏≠‡∏á div ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö slider
        zoomSliderId: 'zoom-slider' // ID ‡∏Ç‡∏≠‡∏á slider
    });

    // --- Employee ID Verification ---
    employeeIdInput.addEventListener('blur', function() {
        const employeeId = this.value.trim();
        fullNameInput.value = '';
        nationalIdInput.value = '';
        
        if (employeeId === '') return;

        const formData = new FormData();
        formData.append('action', 'getEmployeeData');
        formData.append('employeeId', employeeId);

        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.result === 'success') {
                    fullNameInput.value = data.name;
                    nationalIdInput.value = data.nationalId;
                } else if (data.error === 'duplicate_employee_id') {
                    Swal.fire('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'warning');
                } else { // 'invalid_employee_id'
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
            })
            .catch(error => {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
                console.error('Error fetching employee data:', error);
            });
    });

    // --- Consent & Submit Button ---
    consentCheckbox.addEventListener('change', function() {
        registerBtn.disabled = !this.checked;
    });

    // --- Form Submission ---
    form.addEventListener('submit', e => {
        e.preventDefault();

        if (document.getElementById('facePhotoData').value === '') {
             Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô', 'warning');
             return;
        }
        if (document.getElementById('idCardPhotoData').value === '') {
             Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô', 'warning');
             return;
        }
        
        if (!form.checkValidity()) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }
        
        Swal.fire({
            title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        const formData = new FormData(form);
        formData.append('action', 'register'); 

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        position: 'center', icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 2500
                    }).then(() => {
                        if(liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            window.location.reload();
                        }
                    });
                } else if (data.error === 'duplicate_user') {
                    Swal.fire('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 'warning');
                } else if (data.error === 'duplicate_employee_id') {
                    Swal.fire('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 'error');
                } else if (data.error === 'invalid_credentials') {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                } else {
                    throw new Error(data.error || 'Something went wrong');
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            });
    });
});
</script>

</body>
</html>
